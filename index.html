<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flash Words</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="./words.js"></script>

    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: #f1f5f9;
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        .scene {
            perspective: 1000px;
            position: relative;
        }

        .card {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center center;
            cursor: grab;
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            touch-action: none;
        }
        .card:active {
            cursor: grabbing;
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card-next {
            z-index: 0;
            transform: scale(0.95);
            opacity: 0.5;
            pointer-events: none;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
        }
        
        .card-current {
            z-index: 10;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            text-align: center;
            overflow: hidden;
            background-color: white;
        }

        .card-face-back {
            transform: rotateY(180deg);
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
        }

        .card-face-front {
            border: 1px solid #f1f5f9;
        }

        .swipe-right {
            animation: flyRight 0.4s forwards;
        }
        .swipe-left {
            animation: flyLeft 0.4s forwards;
        }

        @keyframes flyRight {
            to { transform: translateX(120%) rotate(20deg); opacity: 0; }
        }
        @keyframes flyLeft {
            to { transform: translateX(-120%) rotate(-20deg); opacity: 0; }
        }

        .screen {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }
        .screen.active {
            display: flex;
        }
        
        #screen-learning.active {
            position: fixed;
            inset: 0;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            touch-action: none;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .pointer-events-none {
            pointer-events: none;
        }
        
        /* 一覧画面の行スタイル */
        .list-row:nth-child(even) {
            background-color: #f8fafc;
        }
        
        /* ボタンのアニメーション */
        .active-scale:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="text-slate-800 transition-colors duration-300">

    <div id="app" class="max-w-md mx-auto min-h-screen relative overflow-hidden bg-slate-50 shadow-2xl">
        
        <div id="screen-setup" class="screen active p-6 overflow-y-auto">
            <header class="mt-8 mb-6 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 text-blue-600 rounded-full mb-4">
                    <i class="ph ph-cards text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-900">単語帳</h1>
                <p class="text-xs text-slate-400 mt-1">Ver 2.1</p>
            </header>

            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-sm flex items-center gap-2 text-slate-600">
                        <i class="ph ph-chart-pie-slice text-lg"></i> 学習状況
                    </h2>
                    <button id="btn-show-list" class="text-blue-600 text-xs font-bold hover:bg-blue-50 px-3 py-1 rounded-full transition-colors flex items-center gap-1 active-scale">
                        <i class="ph ph-list-dashes"></i> 一覧を見る
                    </button>
                </div>
                
                <div class="flex items-center mb-2 h-4 rounded-full overflow-hidden bg-slate-100 w-full relative">
                    <div id="bar-ok" class="bg-green-500 h-full transition-all duration-500" style="width: 0%"></div>
                    <div id="bar-ng" class="bg-red-400 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                
                <div class="grid grid-cols-3 text-center text-xs mt-3">
                    <div>
                        <span class="block font-bold text-green-600 text-lg" id="stat-ok">0</span>
                        <span class="text-slate-400">覚えた</span>
                    </div>
                    <div class="border-l border-slate-100">
                        <span class="block font-bold text-red-500 text-lg" id="stat-ng">0</span>
                        <span class="text-slate-400">苦手</span>
                    </div>
                    <div class="border-l border-slate-100">
                        <span class="block font-bold text-slate-500 text-lg" id="stat-total">0</span>
                        <span class="text-slate-400">全単語</span>
                    </div>
                </div>
            </div>

            <button id="btn-resume" class="hidden w-full mb-6 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl shadow-md flex items-center justify-center gap-2 transform active:scale-95 transition-all">
                <i class="ph ph-arrow-u-up-right text-xl"></i> 続きから学習を再開
            </button>

            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 ml-1">セクション選択</label>
                    <div class="relative">
                        <select id="select-section" class="w-full p-3 pr-10 rounded-xl bg-white border border-slate-200 text-slate-700 font-medium appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <option value="All">すべて</option>
                        </select>
                        <i class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 ml-1">出題順</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="order" value="sequential" checked class="peer hidden">
                            <div class="p-3 rounded-xl border border-slate-200 bg-white text-slate-400 text-center peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-600 transition-all flex items-center justify-center gap-2 active-scale">
                                <i class="ph ph-list-numbers text-lg"></i>
                                <span class="text-xs font-bold">番号順</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="order" value="random" class="peer hidden">
                            <div class="p-3 rounded-xl border border-slate-200 bg-white text-slate-400 text-center peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-600 transition-all flex items-center justify-center gap-2 active-scale">
                                <i class="ph ph-shuffle text-lg"></i>
                                <span class="text-xs font-bold">ランダム</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 ml-1">出題対象</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="target" value="all" checked class="peer hidden">
                            <div class="p-3 rounded-xl border border-slate-200 bg-white text-slate-400 text-center peer-checked:bg-indigo-50 peer-checked:border-indigo-500 peer-checked:text-indigo-600 transition-all active-scale">
                                <span class="text-xs font-bold block">すべて</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="target" value="unlearned" class="peer hidden">
                            <div class="p-3 rounded-xl border border-slate-200 bg-white text-slate-400 text-center peer-checked:bg-slate-100 peer-checked:border-slate-500 peer-checked:text-slate-700 transition-all active-scale">
                                <span class="text-xs font-bold block">未学習のみ</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="target" value="weak_only" class="peer hidden">
                            <div class="p-3 rounded-xl border border-slate-200 bg-white text-slate-400 text-center peer-checked:bg-red-50 peer-checked:border-red-500 peer-checked:text-red-600 transition-all active-scale">
                                <span class="text-xs font-bold block">苦手 (NG)</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="target" value="memorized" class="peer hidden">
                            <div class="p-3 rounded-xl border border-slate-200 bg-white text-slate-400 text-center peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-600 transition-all active-scale">
                                <span class="text-xs font-bold block">覚えた (OK)</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <button id="btn-start" class="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transform active:scale-95 transition-all">
                <i class="ph ph-play-circle text-xl"></i> スタート
            </button>

            <div class="mt-8 pt-6 border-t border-slate-200 text-center">
                <button id="btn-reset-data" class="text-slate-400 text-xs underline hover:text-red-500 p-2">
                    すべての学習データをリセット
                </button>
            </div>
            
            <div class="h-8"></div>
        </div>

        <div id="screen-list" class="screen bg-white flex flex-col h-screen">
            <header class="p-4 border-b border-slate-100 bg-white flex items-center sticky top-0 z-20 shadow-sm shrink-0">
                <button id="btn-list-back" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-600 transition-colors active-scale">
                    <i class="ph ph-arrow-left text-xl"></i>
                </button>
                <h2 class="text-lg font-bold text-slate-800 ml-2">単語一覧</h2>
                <div class="ml-auto text-xs text-slate-500" id="list-count">0 words</div>
            </header>
            
            <div class="flex-1 overflow-y-auto p-0" id="list-container">
                </div>
        </div>

        <div id="screen-learning" class="screen bg-slate-100 overflow-hidden relative transition-colors duration-200">
            <div id="learning-bg-overlay" class="absolute inset-0 pointer-events-none z-0 transition-colors duration-200"></div>

            <div class="p-2 pt-3 px-4 flex items-center gap-3 z-10 shrink-0">
                <button id="btn-back" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:text-slate-700 hover:bg-slate-200/50 rounded-full transition-colors active-scale disabled:opacity-30 disabled:pointer-events-none" disabled>
                    <i class="ph ph-arrow-u-up-left text-xl"></i>
                </button>

                <div class="flex-1 h-2.5 bg-slate-200/60 rounded-full overflow-hidden backdrop-blur-sm border border-slate-200/20">
                    <div id="session-progress-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                <span id="session-counter" class="text-sm font-bold text-slate-500 font-mono w-12 text-right">1/10</span>
                
                <button id="btn-quit" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-200/50 rounded-full transition-colors active-scale">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <div class="flex-1 relative flex items-center justify-center p-2 scene-container z-10 min-h-0">
                <div class="scene w-full max-w-sm aspect-[3/4] relative max-h-full">
                    
                    <div id="card-next" class="card card-next">
                         <div class="card-face card-face-front">
                            <span id="card-no-next" class="absolute top-6 left-6 text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">No. ---</span>
                            <div class="flex-1 flex flex-col items-center justify-center w-full px-4 gap-4 pt-16">
                                <h2 id="card-en-next" class="text-4xl font-bold text-slate-800 break-words w-full leading-tight">Next</h2>
                                <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-50 text-blue-600 rounded-full shadow-sm opacity-50">
                                    <i class="ph ph-speaker-high text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="card-current" class="card card-current cursor-pointer">
                        <div class="card-face card-face-front">
                            <span id="card-no" class="absolute top-6 left-6 text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">No. 001</span>
                            
                            <div class="flex-1 flex flex-col items-center justify-center w-full px-4 gap-4 pt-16">
                                <h2 id="card-en" class="text-4xl font-bold text-slate-800 break-words w-full leading-tight">English</h2>
                                <button id="btn-speak-front" class="inline-flex items-center justify-center w-14 h-14 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition-colors pointer-events-auto shadow-sm active:scale-95">
                                    <i class="ph ph-speaker-high text-2xl"></i>
                                </button>
                            </div>

                            <p class="absolute bottom-6 text-xs text-slate-400 flex items-center gap-1">
                                <i class="ph ph-hand-tap"></i> タップして答えを表示
                            </p>
                        </div>

                        <div class="card-face card-face-back">
                            <div class="absolute top-6 left-6 flex gap-2">
                                <span class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">Answer</span>
                            </div>
                            
                            <div class="flex-1 flex flex-col items-center justify-center w-full px-4">
                                <p id="card-en-sub" class="text-lg text-slate-400 font-medium mb-2">English</p>
                                
                                <div class="w-12 h-1 bg-blue-200 rounded-full mb-6"></div>
                                
                                <h3 id="card-ja" class="text-2xl font-bold text-slate-800 leading-relaxed break-words w-full">日本語の意味</h3>
                            </div>

                            <div class="absolute bottom-6 w-full px-6">
                                <p id="card-section" class="text-xs text-slate-400 border-t border-slate-200 pt-4 w-full truncate">Section Name</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 pb-8 grid grid-cols-2 gap-4 z-10 shrink-0 max-w-md mx-auto w-full">
                <button id="btn-ng" class="flex flex-col items-center justify-center p-4 bg-white/90 backdrop-blur-sm border-2 border-red-100 text-red-500 rounded-2xl shadow-sm hover:bg-red-50 active:scale-95 transition-all">
                    <i class="ph ph-x text-3xl mb-1"></i>
                    <span class="font-bold text-xs">わからない</span>
                </button>
                <button id="btn-ok" class="flex flex-col items-center justify-center p-4 bg-white/90 backdrop-blur-sm border-2 border-green-100 text-green-500 rounded-2xl shadow-sm hover:bg-green-50 active:scale-95 transition-all">
                    <i class="ph ph-check text-3xl mb-1"></i>
                    <span class="font-bold text-xs">覚えた！</span>
                </button>
            </div>
        </div>

        <div id="screen-result" class="screen items-center justify-center p-6 bg-slate-50 text-center overflow-y-auto">
            <div class="bg-white p-8 rounded-3xl shadow-lg w-full mb-8 max-w-sm">
                <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-trophy text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Session Complete!</h2>
                <p class="text-slate-500 mb-8 text-sm">今回の学習結果</p>
                
                <div class="flex items-end justify-center gap-1 mb-8">
                    <span id="result-percent" class="text-6xl font-bold text-blue-600">100</span>
                    <span class="text-xl font-bold text-slate-300 mb-2">%</span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-2">
                    <div class="bg-green-50 p-4 rounded-2xl">
                        <p class="text-xs text-green-600 font-bold mb-1">OK</p>
                        <p id="result-ok" class="text-2xl font-bold text-green-700">0</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-2xl">
                        <p class="text-xs text-red-500 font-bold mb-1">NG</p>
                        <p id="result-ng" class="text-2xl font-bold text-red-600">0</p>
                    </div>
                </div>
            </div>

            <div class="space-y-3 w-full max-w-sm">
                <button id="btn-home" class="w-full bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 font-bold py-4 rounded-xl shadow-sm flex items-center justify-center gap-2 active-scale">
                    <i class="ph ph-house text-lg"></i> ホームに戻る
                </button>
                <button id="btn-retry-weak" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 hidden active-scale">
                    <i class="ph ph-arrow-clockwise text-lg"></i> 苦手だけリトライ
                </button>
            </div>
        </div>

    </div>

    <script>
        let appWordList = [];
        
        if (typeof wordList !== 'undefined') {
            appWordList = wordList.map((item, index) => ({
                ...item,
                uid: `${item.section}-${item.no}-${item.en}-${index}`
            }));
        } else {
            window.addEventListener('load', () => {
                setTimeout(() => {
                     if (appWordList.length === 0) {
                         alert('【重要】\nデータファイル (words.js) が読み込めませんでした。');
                     }
                }, 500);
            });
        }

        const STORAGE_KEY_PROGRESS = 'vocab-progress';
        const STORAGE_KEY_SESSION = 'vocab-session';

        const state = {
            queue: [],
            currentIndex: 0,
            progress: {},
            isFlipped: false,
            animating: false
        };

        const els = {
            screens: {
                setup: document.getElementById('screen-setup'),
                list: document.getElementById('screen-list'),
                learning: document.getElementById('screen-learning'),
                result: document.getElementById('screen-result'),
            },
            setup: {
                selectSection: document.getElementById('select-section'),
                btnStart: document.getElementById('btn-start'),
                btnShowList: document.getElementById('btn-show-list'),
                btnResume: document.getElementById('btn-resume'),
                btnReset: document.getElementById('btn-reset-data'),
                
                barOk: document.getElementById('bar-ok'),
                barNg: document.getElementById('bar-ng'),
                // barYet はHTMLから削除しましたが、残していてもエラーにはなりません
                
                statOk: document.getElementById('stat-ok'),
                statNg: document.getElementById('stat-ng'),
                statTotal: document.getElementById('stat-total'),
            },
            list: {
                container: document.getElementById('list-container'),
                count: document.getElementById('list-count'),
                btnBack: document.getElementById('btn-list-back'),
            },
            learning: {
                bgOverlay: document.getElementById('learning-bg-overlay'),
                btnQuit: document.getElementById('btn-quit'),
                btnBack: document.getElementById('btn-back'), // NEW
                
                progressBar: document.getElementById('session-progress-bar'),
                counter: document.getElementById('session-counter'),
                
                card: document.getElementById('card-current'),
                cardEn: document.getElementById('card-en'),
                cardNo: document.getElementById('card-no'),
                cardJa: document.getElementById('card-ja'),
                cardEnSub: document.getElementById('card-en-sub'),
                cardSection: document.getElementById('card-section'),
                
                cardNext: document.getElementById('card-next'),
                cardEnNext: document.getElementById('card-en-next'),
                cardNoNext: document.getElementById('card-no-next'), 

                btnSpeak: document.getElementById('btn-speak-front'),
                btnOk: document.getElementById('btn-ok'),
                btnNg: document.getElementById('btn-ng'),
            },
            result: {
                percent: document.getElementById('result-percent'),
                countOk: document.getElementById('result-ok'),
                countNg: document.getElementById('result-ng'),
                btnHome: document.getElementById('btn-home'),
                btnRetryWeak: document.getElementById('btn-retry-weak'),
            }
        };

        function init() {
            loadProgress();
            
            if (appWordList.length > 0) {
                renderSetupScreen();
                setupEventListeners();
                checkResumeAvailable();
                els.setup.btnStart.disabled = false;
                els.setup.btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                els.setup.btnStart.disabled = true;
                els.setup.btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                els.setup.btnStart.innerHTML = '<i class="ph ph-warning-circle text-xl"></i> データなし';
            }
        }

        /* --- Storage & Logic --- */

        function loadProgress() {
            const saved = localStorage.getItem(STORAGE_KEY_PROGRESS);
            if (saved) {
                try {
                    state.progress = JSON.parse(saved);
                } catch(e) { console.error(e); }
            }
        }

        function saveProgress(uid, status) {
            state.progress[uid] = status;
            localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(state.progress));
        }

        function saveSession() {
            const sessionData = {
                queueUids: state.queue.map(w => w.uid),
                currentIndex: state.currentIndex
            };
            localStorage.setItem(STORAGE_KEY_SESSION, JSON.stringify(sessionData));
        }

        function clearSession() {
            localStorage.removeItem(STORAGE_KEY_SESSION);
            checkResumeAvailable();
        }

        function checkResumeAvailable() {
            const session = localStorage.getItem(STORAGE_KEY_SESSION);
            if (session) {
                try {
                    const data = JSON.parse(session);
                    if (data.queueUids && data.queueUids.length > 0 && data.currentIndex < data.queueUids.length) {
                        els.setup.btnResume.classList.remove('hidden');
                        return;
                    }
                } catch(e) {}
            }
            els.setup.btnResume.classList.add('hidden');
        }

        function switchScreen(screenName) {
            Object.values(els.screens).forEach(el => el.classList.remove('active'));
            els.screens[screenName].classList.add('active');
            
            if (screenName === 'learning') {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        /* --- Setup Screen --- */

        function renderSetupScreen() {
            const sections = Array.from(new Set(appWordList.map(w => w.section)));
            els.setup.selectSection.innerHTML = '<option value="All">すべて</option>';
            sections.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                els.setup.selectSection.appendChild(opt);
            });

            const okCount = appWordList.filter(w => state.progress[w.uid] === 'ok').length;
            const ngCount = appWordList.filter(w => state.progress[w.uid] === 'ng').length;
            const total = appWordList.length;

            els.setup.statOk.textContent = okCount;
            els.setup.statNg.textContent = ngCount;
            els.setup.statTotal.textContent = total;

            // バーの計算（合計100%になるように）
            els.setup.barOk.style.width = `${(okCount / total) * 100}%`;
            els.setup.barNg.style.width = `${(ngCount / total) * 100}%`;
        }

        /* --- List Screen --- */

        function renderListScreen() {
            const container = els.list.container;
            container.innerHTML = ''; 

            els.list.count.textContent = `${appWordList.length} words`;

            appWordList.forEach(word => {
                const status = state.progress[word.uid];
                let statusIcon = '<span class="w-6 h-6 rounded-full bg-slate-100 block"></span>';
                if (status === 'ok') statusIcon = '<i class="ph ph-check-circle text-2xl text-green-500"></i>';
                if (status === 'ng') statusIcon = '<i class="ph ph-x-circle text-2xl text-red-500"></i>';

                const div = document.createElement('div');
                div.className = 'list-row flex items-center p-4 border-b border-slate-100 gap-3';
                div.innerHTML = `
                    <div class="shrink-0 w-8 text-center">${statusIcon}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-400">No.${word.no}</span>
                            <h3 class="font-bold text-slate-800 truncate">${word.en}</h3>
                        </div>
                        <p class="text-sm text-slate-600 truncate">${word.ja}</p>
                    </div>
                    <div class="shrink-0 flex gap-2">
                         <button class="w-8 h-8 flex items-center justify-center text-blue-500 hover:bg-blue-50 rounded-full active-scale" onclick="speak('${word.en.replace(/'/g, "\\'")}')">
                            <i class="ph ph-speaker-high text-lg"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            switchScreen('list');
        }

        /* --- Learning Logic --- */

        function startLearning(options = {}) {
            let queue = [];

            if (options.resume) {
                const session = JSON.parse(localStorage.getItem(STORAGE_KEY_SESSION));
                queue = session.queueUids.map(uid => appWordList.find(w => w.uid === uid)).filter(Boolean);
                state.currentIndex = session.currentIndex;
            } else {
                let mode = 'all'; 
                if (options.retryWeak) {
                    mode = 'weak_only';
                } else {
                    mode = document.querySelector('input[name="target"]:checked').value;
                }
                
                const section = els.setup.selectSection.value;
                const order = document.querySelector('input[name="order"]:checked').value;

                let filtered = appWordList;
                if (section !== 'All') filtered = filtered.filter(w => w.section === section);

                if (mode === 'unlearned') {
                    filtered = filtered.filter(w => !state.progress[w.uid]);
                } else if (mode === 'weak_only') {
                    filtered = filtered.filter(w => state.progress[w.uid] === 'ng');
                } else if (mode === 'memorized') {
                    filtered = filtered.filter(w => state.progress[w.uid] === 'ok');
                }

                if (order === 'random') {
                    filtered = [...filtered].sort(() => Math.random() - 0.5);
                }

                queue = filtered;
                state.currentIndex = 0;
            }

            if (queue.length === 0 || state.currentIndex >= queue.length) {
                alert("学習対象の単語がありません");
                if(options.resume) clearSession();
                return;
            }

            state.queue = queue;
            state.isFlipped = false;
            state.animating = false;

            renderCard();
            switchScreen('learning');
            
            if (!options.resume) saveSession();
        }

        function renderCard() {
            const currentData = state.queue[state.currentIndex];
            const nextData = state.queue[state.currentIndex + 1];
            const total = state.queue.length;

            els.learning.progressBar.style.width = `${(state.currentIndex / total) * 100}%`;
            els.learning.counter.textContent = `${state.currentIndex + 1} / ${total}`;
            
            // Back Button State
            els.learning.btnBack.disabled = state.currentIndex === 0;
            if(state.currentIndex === 0) {
                els.learning.btnBack.classList.add('opacity-30', 'pointer-events-none');
            } else {
                els.learning.btnBack.classList.remove('opacity-30', 'pointer-events-none');
            }

            els.learning.cardEn.textContent = currentData.en;
            els.learning.cardNo.textContent = `No. ${currentData.no}`;
            els.learning.cardJa.textContent = currentData.ja;
            els.learning.cardEnSub.textContent = currentData.en;
            els.learning.cardSection.textContent = currentData.section;

            if (nextData) {
                els.learning.cardNext.style.display = 'block';
                els.learning.cardEnNext.textContent = nextData.en;
                if (els.learning.cardNoNext) els.learning.cardNoNext.textContent = `No. ${nextData.no}`;
            } else {
                els.learning.cardNext.style.display = 'none';
            }

            els.learning.card.classList.remove('is-flipped', 'swipe-right', 'swipe-left');
            els.learning.card.style.transform = '';
            els.learning.bgOverlay.style.backgroundColor = 'transparent';
            state.isFlipped = false;
        }

        function handleNext(status) {
            if (state.animating) return;
            state.animating = true;

            const currentWord = state.queue[state.currentIndex];
            saveProgress(currentWord.uid, status);

            const animationClass = status === 'ok' ? 'swipe-right' : 'swipe-left';
            els.learning.card.classList.add(animationClass);
            
            els.learning.bgOverlay.style.backgroundColor = status === 'ok' 
                ? 'rgba(74, 222, 128, 0.2)' 
                : 'rgba(248, 113, 113, 0.2)';

            setTimeout(() => {
                state.currentIndex++;
                saveSession();

                if (state.currentIndex >= state.queue.length) {
                    clearSession();
                    showResult();
                } else {
                    renderCard();
                    state.animating = false;
                }
            }, 300);
        }
        
        // NEW: Back Function
        function handleBack() {
            if (state.animating || state.currentIndex <= 0) return;
            state.currentIndex--;
            saveSession();
            renderCard();
        }

        function showResult() {
            const sessionQueue = state.queue;
            const okCount = sessionQueue.filter(w => state.progress[w.uid] === 'ok').length;
            const ngCount = sessionQueue.filter(w => state.progress[w.uid] === 'ng').length;
            
            els.result.percent.textContent = Math.round((okCount / sessionQueue.length) * 100);
            els.result.countOk.textContent = okCount;
            els.result.countNg.textContent = ngCount;

            if (ngCount > 0) {
                els.result.btnRetryWeak.classList.remove('hidden');
                els.result.btnRetryWeak.onclick = () => startLearning({ retryWeak: true });
            } else {
                els.result.btnRetryWeak.classList.add('hidden');
            }

            switchScreen('result');
        }

        /* --- Audio & Event Listeners --- */

        let englishVoice = null;
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            englishVoice = voices.find(v => v.lang === 'en-US') 
                        || voices.find(v => v.lang === 'en-GB')
                        || voices.find(v => v.lang.startsWith('en'));
        }
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        window.speak = function(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const uttr = new SpeechSynthesisUtterance(text);
                uttr.lang = 'en-US';
                if (englishVoice) uttr.voice = englishVoice;
                window.speechSynthesis.speak(uttr);
            }
        };

        function setupEventListeners() {
            // Setup Screen
            els.setup.btnStart.addEventListener('click', () => startLearning());
            els.setup.btnResume.addEventListener('click', () => startLearning({ resume: true }));
            els.setup.btnShowList.addEventListener('click', renderListScreen);
            
            els.setup.btnReset.addEventListener('click', () => {
                if(confirm('学習記録をすべて消去しますか？\nこの操作は元に戻せません。')) {
                    localStorage.removeItem(STORAGE_KEY_PROGRESS);
                    localStorage.removeItem(STORAGE_KEY_SESSION);
                    state.progress = {};
                    renderSetupScreen();
                    checkResumeAvailable();
                    alert('リセットしました。');
                }
            });

            // List Screen
            els.list.btnBack.addEventListener('click', () => {
                renderSetupScreen();
                switchScreen('setup');
            });

            // Learning Screen
            els.learning.btnQuit.addEventListener('click', () => {
                loadProgress();
                renderSetupScreen();
                checkResumeAvailable();
                switchScreen('setup');
            });
            
            // NEW: Back Button Listener
            els.learning.btnBack.addEventListener('click', handleBack);

            els.learning.btnOk.addEventListener('click', () => handleNext('ok'));
            els.learning.btnNg.addEventListener('click', () => handleNext('ng'));
            
            els.learning.btnSpeak.addEventListener('click', (e) => {
                e.stopPropagation();
                window.speak(state.queue[state.currentIndex].en);
            });

            // Result Screen
            els.result.btnHome.addEventListener('click', () => {
                renderSetupScreen();
                switchScreen('setup');
            });

            // --- Swipe Logic ---
            const cardContainer = els.learning.card;
            let startX = null;
            let currentX = 0;
            let isDragging = false;

            const handleStart = (clientX) => {
                if (state.animating) return;
                startX = clientX;
                currentX = clientX;
                isDragging = true;
                cardContainer.style.transition = 'none';
            };

            const handleMove = (clientX) => {
                if (!isDragging || startX === null) return;
                currentX = clientX;
                const diff = currentX - startX;
                
                const rotate = diff * 0.1;
                const baseRotate = state.isFlipped ? 180 : 0;
                cardContainer.style.transform = `translateX(${diff}px) rotateY(${baseRotate + (diff * 0.05)}deg) rotateZ(${rotate * 0.2}deg)`;

                const opacity = Math.min(Math.abs(diff) / 300, 0.3);
                
                if (diff > 0) {
                    els.learning.bgOverlay.style.backgroundColor = `rgba(74, 222, 128, ${opacity})`; 
                } else {
                    els.learning.bgOverlay.style.backgroundColor = `rgba(248, 113, 113, ${opacity})`;
                }
            };

            const handleEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                const diff = currentX - startX;

                if (Math.abs(diff) > 100) {
                    handleNext(diff > 0 ? 'ok' : 'ng');
                } else {
                    cardContainer.style.transition = 'transform 0.3s ease';
                    cardContainer.style.transform = ''; 
                    els.learning.bgOverlay.style.backgroundColor = 'transparent';
                    setTimeout(() => { cardContainer.style.transition = ''; }, 300);
                }
                startX = null;
            };

            // Touch events
            cardContainer.addEventListener('touchstart', (e) => handleStart(e.touches[0].clientX), { passive: true });
            cardContainer.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    e.preventDefault(); 
                    handleMove(e.touches[0].clientX);
                }
            }, { passive: false });
            cardContainer.addEventListener('touchend', handleEnd);

            // Mouse events
            cardContainer.addEventListener('mousedown', (e) => handleStart(e.clientX));
            window.addEventListener('mousemove', (e) => {
                if(isDragging) {
                    e.preventDefault();
                    handleMove(e.clientX);
                }
            });
            window.addEventListener('mouseup', () => {
                if(isDragging) handleEnd();
            });

            // Flip
            els.learning.card.addEventListener('click', (e) => {
                if (state.animating) return;
                if (startX && Math.abs(currentX - startX) > 10) return;
                
                state.isFlipped = !state.isFlipped;
                els.learning.card.classList.toggle('is-flipped', state.isFlipped);
            });
        }

        init();
    </script>
</body>
</html>